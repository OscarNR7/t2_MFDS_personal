version: 1
applications:
  - appRoot: waste_to_treasure/frontend
    
    # SECCIÓN DE BACKEND (Corregida)
    backend:
      phases:
        build:
          commands:
            - nvm use 20
            # 1. Navegamos DE VUELTA a la raíz del monorepo
            - cd ../..
            # 2. Ejecutamos el push desde la raíz
            #    (Aquí sí encontrará tu proyecto Amplify/Cognito)
            - amplifyPush --simple
            
    # SECCIÓN DE FRONTEND (Se queda casi igual)
    frontend:
      phases:
        preBuild:
          commands:
            - nvm use 20
            # 3. Estos comandos SÍ se ejecutan dentro de 'appRoot'
            - echo "API_URL=$NEXT_PUBLIC_API_URL"
            - rm -rf .next
            - rm -rf node_modules/.cache
            - npm ci --legacy-peer-deps
        build:
          commands:
            - echo "Building with API_URL=$NEXT_PUBLIC_API_URL"
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
    customHeaders:
      - pattern: '**/*'
        headers:
          - key: 'X-Frame-Options'
            value: 'DENY'
          - key: 'X-Content-Type-Options'
            value: 'nosniff'